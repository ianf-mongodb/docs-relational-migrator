.. _rm-prereq-oracle:

==============================
Oracle Migration Prerequisites
==============================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

To run sync jobs from an Oracle source database, the database may require 
some configuration changes. If Relational Migrator determines the 
database needs configuration changes, it automatically generates a 
SQL script with the required changes. It is recommended to have a 
Database Administrator (DBA) review the commands in this script and 
perform their execution on the database server. The 
Oracle configurations depend on the type of sync job:

.. include:: /includes/fact-short-sync-job-desc.rst

For details on supported versions of Oracle, see 
:ref:`supported-databases`.

Steps
-----

.. tabs::

   .. tab:: Snapshot Jobs
      :tabid: enable-snapshot-jobs

      .. procedure::
         :style: normal

         .. step:: Set up user permissions

            .. include:: /includes/fact-data-prep-oracle-step1.rst

   .. tab:: Continuous Jobs
      :tabid: enable-continuous-jobs

      .. procedure::
         :style: normal

         .. step:: Set up user permissions

            .. include:: /includes/fact-data-prep-oracle-step1.rst

            c. Grant additional permissions to the service account 
               in order to run continuous sync jobs:

                .. code-block:: sql
                    :copyable: true

                    GRANT SET CONTAINER TO user;
                    GRANT FLASHBACK ANY TABLE TO user;
                    GRANT EXECUTE_CATALOG_ROLE TO user;
                    GRANT SELECT ANY TRANSACTION TO user;
                    GRANT LOGMINING TO user;
                    GRANT CREATE TABLE TO user;
                    GRANT LOCK ANY TABLE TO user;
                    GRANT CREATE SEQUENCE TO user;
                    GRANT SELECT ON DBA_TABLESPACES TO user; 
                    GRANT EXECUTE ON DBMS_LOGMNR TO user;
                    GRANT EXECUTE ON DBMS_LOGMNR_D TO user;
                    GRANT SELECT ON V_$LOG TO user;
                    GRANT SELECT ON V_$LOG_HISTORY TO user;
                    GRANT SELECT ON V_$LOGMNR_LOGS TO user;
                    GRANT SELECT ON V_$LOGMNR_CONTENTS TO user;
                    GRANT SELECT ON V_$LOGMNR_PARAMETERS TO user;
                    GRANT SELECT ON V_$LOGFILE TO user;
                    GRANT SELECT ON V_$ARCHIVED_LOG TO user;
                    GRANT SELECT ON V_$ARCHIVE_DEST_STATUS TO user;
                    GRANT SELECT ON V_$TRANSACTION TO user;

            If your Oracle instance is hosted on AWS RDS, then use the 
            `rdsadmin.rdsadmin_util.grant_sys_object 
            <https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Appendix.Oracle.CommonDBATasks.System.html#Appendix.Oracle.CommonDBATasks.TransferPrivileges>`__ 
            stored procedure for all grant statements:

            .. code-block:: sql
                :copyable: true
        
                CALL rdsadmin.rdsadmin_util.grant_sys_object('V_$DATABASE', 'user', 'SELECT');

         .. step:: Turn on ``LogMiner`` at the database level
            
            In order to run continous jobs against Oracle, you must enable 
            ``LogMiner`` at the database level. The following code-block
            is an example of automatically-generated code, which you 
            can run manually by substituting your database name:

            .. code-block:: sql
                :copyable: true

                ALTER SYSTEM SET db_recovery_file_dest_size = 10G;
                ALTER SYSTEM SET db_recovery_file_dest = '/opt/oracle/oradata/recovery_area' SCOPE=spfile;
                SHUTDOWN IMMEDIATE;
                STARTUP MOUNT
                ALTER DATABASE ARCHIVELOG;
                ALTER DATABASE OPEN;
            
            .. tip::

                To check if ``LogMiner`` is already enabled, run the 
                following query:

                .. code-block:: sql
                   :copyable: true

                    SELECT LOG_MODE FROM V$DATABASE; 
    
         .. step:: Enable supplemental logging

            a. To run continuous sync jobs against Oracle, you must 
               enable supplemental logging at the database level:

               .. code-block:: sql
                  :copyable: true

                  ALTER DATABASE ADD SUPPLEMENTAL LOG DATA; 

            #. You must also enable supplemental logging for every 
               table in the migration:

               .. code-block:: sql
                  :copyable: true

                  ALTER TABLE schemaName.tableName ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS;
                  /* Additional ALTER TABLE STATEMENTS... */ 

Learn More
----------

Relational Migrator relies on the open-source Debezium connector to 
capture row-level changes. For more details, see:

- `Debezium Oracle <https://debezium.io/documentation/reference/stable/connectors/oracle.html#_preparing_the_databas>`__
- `Oracle docs how to toggle archive logging <https://docs.oracle.com/cd/B19306_01/server.102/b14231/archredo.htm>`__.
