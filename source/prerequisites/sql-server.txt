.. _rm-prereq-sqlserver:

==================================
SQL Server Migration Prerequisites
==================================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Connecting Relational Migrator to SQL Server requires Change Data 
Capture (CDC) mode enabled. When you set up a new connection, 
Relational Migrator automatically generates the required SQL code for 
configuring SQL Server. How you configure SQL Server varies 
depending on if you are running a Snapshot or a Continuous sync job.

- Snapshot sync jobs migrate all the data and then stops.
- Continuous run a snapshot and then enters a CDC stage to 
  continuously replicate changes.

For details on sync job types see :ref:`rm-sync-jobs`.

About this Task
---------------

- This page covers the details of the SQL scripts automatically 
  generated by Relational Migrator.

- Relational Migrator automatically detects SQL Server CDC settings when 
  connecting to your database and generates the appropriate SQL 
  statements to enable CDC if required.

- You can also check SQL Server CDC settings by examining the ``is_tracked_by_cdc`` 
  column in the `sys.tables catalog view <https://learn.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-tables-transact-sql?view=sql-server-ver16>`__. 
  A value of ``1`` for ``is_tracked_by_cdc`` indicates the table 
  is enabled for change data capture.

- Relational Migrator does not create any indexes on SQL Server to 
  facilitate sync jobs. The create index creation permission is not 
  required.

Before you Begin
----------------

To enable the CDC option on SQL Server:

- You must have the server level ``sysadmin`` role. 
- You must have the database level ``db_owner`` role.
- The `SQL Server agent <https://learn.microsoft.com/en-us/sql/ssms/agent/sql-server-agent?view=sql-server-ver16>`__
  must be running.
- The service account used to connect to SQL Server requires 
  Select permission against all required tables.

Steps
-----

The easiest way to set up your database is to run the generated script. 
If you would like to understand the permissions, or run the SQL 
manually read the procedures below.

Depending on the type of sync job you need to run, you need to 
configure your SQL Server Instance appropriately. Use the tab below
for details on how to configure your database for snapshot and 
continuous sync jobs.

.. tabs::

   .. tab:: Snapshot Jobs
      :tabid: enable-snapshot-jobs

      For Snapshot jobs against SQL Server, you must enable 
      CDC at the database level. 

      .. procedure::
         :style: normal

         .. step:: Configure CDC at the Database Level

            .. include:: /includes/fact-enable-cdc-database.rst

   .. tab:: Continuous Jobs
      :tabid: enable-continuous-jobs

      For Continuous jobs against SQL Server, you must enable 
      CDC at both the database level and at the table level for 
      each table that you want to track.

      .. procedure::
         :style: normal

         .. step:: Configure CDC at the Database Level

            .. include:: /includes/fact-enable-cdc-database.rst

         .. step:: Configure CDC at the Table Level

            To enable CDC at the table level
            use the ``sys.sp_cdc_enable_table`` stored procedure. 

            The code block below is a sample of the 
            automatically-generated code.

            You can run the code manually to enable table CDC:

            .. code-block:: sql
               :copyable: false

               USE MyDB
               GO
               EXEC sys.sp_cdc_enable_table
               @source_schema = N'dbo',
               @source_name   = N'MyTable',
               @role_name     = N'MyRole',
               @filegroup_name = N'MyDB_CT',
               @supports_net_changes = 1
               GO

Learn More
----------

Relational Migrator relies on the open-source Debezium connector to 
capture row-level changes. For details on the Debezium connector, see
`Debezium SQL Server <https://debezium.io/documentation/reference/stable/connectors/sqlserver.html#_enabling_cdc_on_a_sql_server_table>`__.

