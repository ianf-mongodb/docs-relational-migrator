.. _rm-prereq-sqlserver:

==================================
SQL Server Migration Prerequisites
==================================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Connecting Relational Migrator to SQL Server requires Change Data 
Capture (CDC) mode enabled. When you set up a new connection, 
Relational Migrator automatically generates the required SQL code for 
configuring SQL Server. Setup differs slightly 
depending on if your running a Snapshot or Continuous sync job. 
For details on sync job types see :ref:`rm-sync-jobs`.

About this Task
---------------

This page covers the details of the SQL scripts automatically 
generated by Relational Migrator.

Relational Migrator automatically detects your CDC settings when 
connecting to your database and generates the appropriate SQL 
statements to enable CDC if required.

.. tip::

   You can also check CDC settings by examining the ``is_tracked_by_cdc`` 
   column in the `sys.tables catalog view <https://learn.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-tables-transact-sql?view=sql-server-ver16>`__. 
   A bit value of ``1`` in the ``sys.tables`` view indicates the table 
   is enabled for change data capture.

Before you Begin
----------------

To enable the CDC option on SQL Server:

- You must have the server level ``sysadmin`` role. 
- You must have the database level ``db_owner`` role.
- The `SQL Server agent <https://learn.microsoft.com/en-us/sql/ssms/agent/sql-server-agent?view=sql-server-ver16>`__
  must be running.

.. note::

    The service account used to connect to the SQL Server requires 
    Select permission against all required tables.

Steps
-----

Depending on the type of sync job you need to run, you need to 
configure your SQL Server Instance appropriately. Use the tab below
for details on how to configure your database for snapshot and 
continuous sync jobs.

.. tabs::

   .. tab:: Snapshot Jobs
      :tabid: enable-snapshot-jobs

      For Snapshot jobs against SQL Server, you must enable 
      CDC at the database level. 

      .. procedure::
         :style: normal

         .. step:: Configure CDC at the Database Level

            .. include:: /includes/fact-enable-cdc-database.rst

   .. tab:: Continuous Jobs
      :tabid: enable-continuous-jobs

      For Continuous jobs against SQL Server, you must enable 
      CDC at both the database level and at the table level for 
      each table that you want to track.

      .. procedure::
         :style: normal

         .. step:: Configure CDC at the Database Level

            .. include:: /includes/fact-enable-cdc-database.rst

         .. step:: Configure CDC at the Table Level

            To enable CDC at the table level
            use the ``sys.sp_cdc_enable_table`` stored procedure. 

            The code block below is a sample of the 
            automatically-generated code.

            You can run the code manually by:

            - Substituting the database name for ``MyDB``
            - Substituting role name for ``MyRole``
            - Substituting your filegroup name for ``MyDB_CT``
            - Substituting the table name for ``MyTable``

            You must run this stored procedure on each table in the 
            migration.

            .. code-block:: sql
               :copyable: false

               USE MyDB
               GO
               EXEC sys.sp_cdc_enable_table
               @source_schema = N'dbo',
               @source_name   = N'MyTable',
               @role_name     = N'MyRole',
               @filegroup_name = N'MyDB_CT',
               @supports_net_changes = 1
               GO

Learn More
----------

The migrator tool relies on the open-source Debezium connector to 
capture row-level changes. For details on the Debezium connector, see
`Debezium SQL Server <https://debezium.io/documentation/reference/stable/connectors/sqlserver.html#_enabling_cdc_on_a_sql_server_table>`__.
