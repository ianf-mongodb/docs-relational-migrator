.. _rm-prereq-sqlserver:

==================================
SQL Server Migration Prerequisites
==================================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

When you setup a new connection, the Migrator tool will automatically 
generate the required SQL code for a database administrator. 
Connecting Migrator to SQL Server requires a database administrator to 
enable change data capture (CDC) mode on the database, if not already 
enabled. Relational Migrator supports two types of sync jobs:

- Snapshot which migrates all the data and then stops.
- Continuous which runs a snapshot and then enters a CDC stage to 
  continuously replicate changes.

About this Task
---------------

To enable CDC for that job, which they can inspect and manually execute.
It will take a few minutes to review and execute the generated SQL code 
script. This document explains the purpose of those scripts.

For one-time enablement of CDC mode, a database administrator must 
manually enable this setting. The administrator requires sysadmin 
permission, db_owner permission for the database, and SQL Server agent 
must be running. Check If CDC Mode Already Enabled

Simply setup a new data migration job, and when you input your SQL 
Server account details on the 'Source Database' connection screen, 
the tool will automatically detect your CDC status and generate SQL 
statements to enable this if required. You can also check manually by 
examining the is_tracked_by_cdc column in the ``sys.tables`` catalog 
view. Documentation from Microsoft explaining these options can be 
found at Enable and Disable change data capture 

- `SQL Server <https://learn.microsoft.com/en-us/sql/relational-databases/track-changes/enable-and-disable-change-data-capture-sql-server?view=sql-server-ver16>`__

Before you Begin
----------------

The migrator SQL Server account requires Select permission against all 
required tables.

Steps
-----

.. procedure::

   .. step:: Configure Database

      Depending on the type of sync job you need to run, you need to 
      configure your SQL Server Instance appropriatly. Use the tab below
      for details on how to configure your database for snapshot and 
      continuous sync jobs.

      ..tabs:: 
        .. tab:: Snapshot Jobs
           :tabid: enable-snapshot-jobs

           For Snapshot jobs against SQL Server, it is necessary to enable CDC at 
           the database level. This creates a small number of system tables in the 
           database, but it does not change any user tables, and it does not by 
           itself result in changes being captured from your tables or introduce 
           any performance overheads. This is a sample of 
           the automatically-generated code, which you could also run manually by 
           substituting your database name:

           .. code-block:: sql
              :copyable: false

              USE MyDB

              GO

              EXEC sys.sp_cdc_enable_db

              GO

           .. tab:: Continuous Jobs
              :tabid: enable-continuous-jobs

              For Continuous jobs against SQL Server, it is necessary to enable 
              CDC at both the database level as above, and at the table level for 
              each table that you want to track, using the sys.sp_cdc_enable_table 
              function. The tool will automatically generate the required SQL query. 
              This is a sample of the automatically-generated code, which you 
              could also run manually by substituting your table name for each table:

              .. code-block:: sql
                 :copyable: false

                 USE MyDB

                 GO

                 EXEC sys.sp_cdc_enable_db

                 GO

   .. step:: Enable a Table Specifying Filegroup Option Template

   .. code-block:: sql
      :copyable: false

      USE MyDB

      GO

      EXEC sys.sp_cdc_enable_table

      @source_schema = N'dbo',

      @source_name   = N'MyTable',

      @role_name     = N'MyRole',

      @filegroup_name = N'MyDB_CT',

      @supports_net_changes = 1

      GO


Learn More
----------

The migrator tool relies on the open-source Debezium connector to 
capture row-level changes.

`Debezium SQL Server <https://debezium.io/documentation/reference/stable/connectors/sqlserver.html#_enabling_cdc_on_a_sql_server_table>`__

`Enable and Disable change data capture - SQL Server <https://learn.microsoft.com/en-us/sql/relational-databases/track-changes/enable-and-disable-change-data-capture-sql-server?view=sql-server-ver16>`__

x