.. _rm-prereq-sqlserver:

==================================
SQL Server Migration Prerequisites
==================================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

When you set up a new connection, Relational Migrator automatically 
generates the required SQL code for configuring the relational database. 
Connecting Relational Migrator to SQL Server requires change data 
capture (CDC) mode enabled. Setup differs slightly depending if your 
running a Snapshot or Continuous sync job. For details on sync job 
types see :ref:`rm-sync-jobs`.

About this Task
---------------

This page covers the details of the SQL scripts automatically 
generated by Relational Migrator.

Relational Migrator automatically detects your CDC settings when 
connecting to your database and generates the appropriate SQL 
statements to enable CDC if required.

.. tip::

   You can also check CDC settings by examining the ``is_tracked_by_cdc`` 
   column in the ``sys.tables`` catalog view. 
   For details, see `Enable and Disable change data capture  
   <https://learn.microsoft.com/en-us/sql/relational-databases/track-changes/enable-and-disable-change-data-capture-sql-server?view=sql-server-ver16>`__ .

Before you Begin
----------------

To enable the CDC option on SQL Server:

- You must have the server level ``sysadmin`` role. 
- You must have the database level ``db_owner`` role.
- The `SQL Server agent <https://learn.microsoft.com/en-us/sql/ssms/agent/sql-server-agent?view=sql-server-ver16>`__
  must be running.

.. note::

    The service account used to connect to the SQL Server requires 
    Select permission against all required tables.

Steps
-----

Depending on the type of sync job you need to run, you need to 
configure your SQL Server Instance appropriately. Use the tab below
for details on how to configure your database for snapshot and 
continuous sync jobs.

.. tabs::

   .. tab:: Snapshot Jobs
      :tabid: enable-snapshot-jobs

      .. procedure::
         :style: normal

         For Snapshot jobs against SQL Server, it is necessary to enable 
         CDC at the database level. 

         This creates a small number of system tables in the database, but it does not change any 
         user tables, and it does not by itself result in changes being 
         captured from your tables or introduce any performance 
         overheads. 

         .. step:: Configure CDC at the Database Level

         The code block below is a sample of the automatically-generated 
         code which you can run manually by substituting your 
         database name for ``MyDB``:

         .. code-block:: sql
            :copyable: false

            USE MyDB
            GO
            EXEC sys.sp_cdc_enable_db
            GO

   .. tab:: Continuous Jobs
      :tabid: enable-continuous-jobs

      For Continuous jobs against SQL Server, it is necessary to enable 
      CDC at both the database level and at the table level for 
      each table that you want to track. To enable CDC at the table level
      use the ``sys.sp_cdc_enable_table`` function. 
      
      This is a sample of the automatically-generated code, which you 
      could also run manually by substituting your table name for each table:

      .. procedure::
         :style: normal

         .. step:: Configure CDC at the Database Level
            
            .. code-block:: sql
               :copyable: false

               USE MyDB
               GO
               EXEC sys.sp_cdc_enable_db
               GO

         .. step:: Configure CDC at the Database Level

            .. code-block:: sql
               :copyable: false

               USE MyDB
               GO
               EXEC sys.sp_cdc_enable_table
               @source_schema = N'dbo',
               @source_name   = N'MyTable',
               @role_name     = N'MyRole',
               @filegroup_name = N'MyDB_CT',
               @supports_net_changes = 1
               GO

Learn More
----------

The migrator tool relies on the open-source Debezium connector to 
capture row-level changes.

- `Debezium SQL Server <https://debezium.io/documentation/reference/stable/connectors/sqlserver.html#_enabling_cdc_on_a_sql_server_table>`__
- `Enable and Disable change data capture - SQL Server <https://learn.microsoft.com/en-us/sql/relational-databases/track-changes/enable-and-disable-change-data-capture-sql-server?view=sql-server-ver16>`__

