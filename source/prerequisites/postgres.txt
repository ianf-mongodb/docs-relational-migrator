.. _rm-prereq-postgres:

==================================
PostgreSQL Migration Prerequisites
==================================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Connecting Relational Migrator to PostgreSQL requires
`logical decoding 
<https://www.postgresql.org/docs/current/logicaldecoding-explanation.html>`__ 
to be enabled on your PostgreSQL instance. When you set up a new connection, 
Relational Migrator automatically generates the required SQL code to 
configure PostgreSQL. This document explains the purpose of those scripts.

These instructions configure PostgreSQL *for both* Snapshot and 
Continuous sync jobs.

- Snapshot sync jobs migrate all the data and then stop.
- Continuous sync jobs run a snapshot and then enter a CDC stage to 
  continuously replicate data changes.

About this Task
---------------

Relational Migrator uses the PostgreSQL ``pgoutput`` plugin for logical 
decoding. This plug-in is included in PostgreSQL versions 10+, no 
additional installation or configuration is required. 

Before you Begin
----------------

If PostgreSQL is configured as a cluster, Relational Migrator must connect
to the master server.

Steps
-----

.. procedure::
   :style: normal

   .. step:: Edit the configuration file 

      Logical replication may not be enabled by default. To enable logical 
      replication, change the `wal_level <https://postgresqlco.nf/doc/en/param/wal_level>`__ 
      configuration in the 
      `postgresql.conf configuration file <https://www.postgresql.org/docs/current/config-setting.html>`__. 
      You *must restart the database instance* after changing the configuration file. 

      .. code-block:: none

         wal_level = logical 

   .. step:: Create a SQL replication role

      a. Create a role with ``REPLICATION`` and ``LOGIN`` 
         database permissions:

         .. code-block:: sql

            CREATE ROLE <name> REPLICATION LOGIN;

      #. Grant the required ``SELECT`` table and ``USAGE``
         schema permissions to the role:

         .. code-block:: sql
            :copyable: true

            GRANT USAGE ON SCHEMA schema_name TO <role_name>;
            GRANT SELECT ON table_name TO <role_name>;

      #. Grant the role to the service account user:

         .. code-block:: sql
            :copyable: true

            GRANT <role_name> TO <user>;

   .. step:: Create a publication

      Relational Migrator requires you create a 
      `publication <https://www.postgresql.org/docs/current/logical-replication-publication.html>`__ 
      by running:

      .. code-block:: sql

         CREATE PUBLICATION "migrator_<name>_publication" FOR TABLE <tables>; 

Learn More
----------

Relational Migrator relies on the open-source Debezium connector to 
capture row-level changes. For more details, see
`Debezium PostgreSQL <https://debezium.io/documentation/reference/stable/connectors/postgresql.html>`__.