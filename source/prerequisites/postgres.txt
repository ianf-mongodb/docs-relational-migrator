.. _rm-prereq-postgres:

================================
Postgres Migration Prerequisites
================================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

About this Task
---------------

Connecting Relational Migrator to Postgres requires
`logical decoding 
<https://www.postgresql.org/docs/current/logicaldecoding-explanation.html>`__ 
enabled. When you set up a new connection, Relational Migrator
automatically generates the required SQL code to configure PostgreSQL. 
This document explains the purpose of those scripts.

These instructions configure PostgreSQL for both Snapshot and 
Continuous sync jobs.

- Snapshot sync jobs migrate all the data and then stops.
- Continuous sync job run a snapshot and then enter a CDC stage to 
  continuously replicate data changes.

About this Task
---------------

Relational Migrator uses ``pgoutput`` plugin for logical decoding. 
This plug-in is included in PostgreSQL versions 10+, no additional 
installation or configuration is required. 

Before you Begin
----------------

If PostgreSQL is configured as a cluster, the tool must be connected 
to a master server.

Steps
-----

.. procedure::
   :style: normal


   .. step:: Edit the Configuration file 

      Logical replication may not be enabled by default. To enable logical 
      replication change the following line in the ``postgresql.conf`` 
      `configuration file <https://www.postgresql.org/docs/current/config-setting.html>`__. 
      You must restart the database instance after changing the configuration file.  

      .. code-block:: none

         wal_level = logical 

      For more information on ``wal_level``, see 
      `logical decoding <https://postgresqlco.nf/doc/en/param/wal_level>`__ 

   .. step:: Create a SQL Replication Login

      The PostgreSQL account requires at least REPLICATION and LOGIN 
      permission on the database, and SELECT and USAGE permissions on the source tables:

      .. code-block:: sql

         CREATE ROLE <name> REPLICATION LOGIN;

   .. step:: Create a Publication

      Migrator requires creating a 
      `publication <https://www.postgresql.org/docs/current/logical-replication-publication.html>`__ 
      by running:

      .. code-block:: sql

         CREATE PUBLICATION "migrator_<name>_publication" FOR TABLE <tables>; 

Learn More
----------

Relational Migrator uses on the open-source Debezium connector to 
capture row-level changes. Debezium PostgreSQL 
`logical decoding <https://debezium.io/documentation/reference/stable/connectors/postgresql.html>__.